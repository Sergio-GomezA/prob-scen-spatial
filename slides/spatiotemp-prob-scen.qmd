---
title: "Spatiotemporal Probabilistic Scenarios"
author:
  - "S. Gomez$^1$"
institute:
   - $^1$School of Mathematics, University of Edinburgh
institute-short: "UoE"
date: "2026-02-04"
format: 
  beamer:
    theme: Rochester
    colortheme: spruce
    fonttheme: professionalfonts
    fig-cap-location: top
    toc: true
    slide-level: 2
    split-bib: true
    output-file: "st-prob-scen_slides_26-02-04.pdf"
header-includes:
  - \usepackage{graphicx}
fontsize: 12pt
aspectratio: 169
editor: source
---

```{r include=FALSE}
# bibliography: calib_pow_ref.bib
# nocite: "@*"
require(tidyverse)
require(kableExtra)
require(parallel)
require(dplyr)
require(scales)
require(ggsci)

require(sf)
library(rnaturalearth)
library(rnaturalearthdata)

require(ggthemes)
require(arrow)
pre_path <- ifelse(grepl("prob-scen-spatial$",getwd()),getwd(),"..")
# source(file.path(pre_path,"aux_funct.R"))
source(file.path(pre_path,"aux_funct_ps.R"))
path <- "~/Documents/proj2/spatial"
```

```{r}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE, cache = FALSE)
theme_set(theme_bw())
```

# Overview {#sec-intro}

## Progress check {#sec-updates .unnumbered .nolink}

### New
- Spatial modelling
- Model estimates
- PC fitting

### Next Steps
- OOS validation
- Add case study to overleaf
- Address other comments


# Spatial modelling for probabilistic scenarios

## Model shapes

New models are modifications of the Normalised Error with Normal distribution (NEN)

- Model list
  - ST-PR-NEN
  - Power Ramp (PR-NEN)
  - AR1 (PR-AR1-NEN)
  - Matern-AR1 (ST-NEN)

- Pending
  - ST-RS-PR-NEN

## Data

::: {.columns}

::: {.column width="50%"}

- For US data:
  - Length: 18 months
  - Resolution: hourly
  - Locations: 1 region aggregated
- UK data:
  - Length: 1 to 3 months
  - Resolution: hourly
  - Locations 10 Scottish wind farms

Trying to keep $\text{fit time} < 60\text{min}$
:::

::: {.column width="50%"}
\centering
\small 10 Scottish wind farms

\includegraphics[width=\linewidth,height=5cm,keepaspectratio]{../fig/Scottish_wfsamp_24_map.pdf}
:::

:::

## ST-PR-NEN model

\centering
\small
Parameters summary

```{r}
# proj_dir <- "/home/s2441782/ownCloud-s2441782@datasync.ed.ac.uk/projects/proj2/prob-scen-spatial"
# slides_dir <- "/home/s2441782/ownCloud-s2441782@datasync.ed.ac.uk/projects/proj2/prob-scen-spatial/slides"
# setwd(slides_dir)
# setwd(proj_dir)
model_fname <- "r_err.cf_f_gaussian_eta_feat_ws.w_group-matern-ar1-etaderiv.rds"

prefix <- model_fname %>% gsub(".rds", "", .)
params_fname <- file.path(
  pre_path,
  "data",
  paste0("params_", prefix, ".csv")
)

if (!file.exists(params_fname)) {
  save_model_figures(model_fname)
}

parameter_summaries <- read.csv(params_fname)
parameter_summaries %>%
  kable(
    digits = 2, #c(2, 0, 0, 1, 2, 2, 2),
    format = "latex",
    escape = FALSE
  ) %>%
  kable_styling(
    latex_options = "scale_down"
  )

# print(mod.temp$.args$formula)


```

## Effects
::: {.columns}

::: {.column width="50%"}
\centering
\small Effects
```{r fig.height = 3, fig.show="hold" ,results="asis"}

eff_pattern <- sprintf("^peff.*_mod_%s.pdf$", prefix)
eff_plots <- list.files(path = "../fig", pattern = eff_pattern,full.names = TRUE)

knitr::include_graphics(eff_plots)

```
:::

::: {.column width="50%"}

\centering
\small Spatial effect
```{r fig.height = 5}

p_pattern <- sprintf("^speff.*_mod_%s.pdf$", prefix)
p_plots <- list.files(path = "../fig", pattern = p_pattern,full.names = TRUE)

knitr::include_graphics(p_plots)
```
:::

:::

## Posterior distributions
::: {.columns}

::: {.column width="50%"}
\centering
\small Day-ahead forecast
```{r fig.height = 3, fig.show="hold" ,results="asis"}

ts_plots <- "../fig/ts_wfsamp_24-07-01.pdf"

knitr::include_graphics(ts_plots)

```
:::

::: {.column width="50%"}

\centering
\small Hyperparameters
```{r fig.height = 5}

hyper_pattern <- sprintf("^phyper.*_mod_%s.pdf$", prefix)
hyper_plots <- list.files(path = "../fig", pattern = hyper_pattern,full.names = TRUE)

knitr::include_graphics(hyper_plots)
```
:::

:::

## PR-NEN model

::: {.columns}

::: {.column width="60%"}
\centering
\small
Parameters summary
\tiny
```{r}
# path <- "~/Documents/proj2/spatial/model_objects/"
# fname <- file.path(pre_path,"data", "PR-NEN_summary.csv")

# mod.temp <- readRDS(file.path(
#   path,
#   "r_err.cf_f_gaussian_eta_feat_ws.w_group-etaderiv.rds"
# ))

# # print(mod.temp$.args$formula)
# temp_summary <- cbind(
#   mod.temp$summary.fixed[-7] %>% t(),
#   mod.temp$summary.hyperpar %>% t()
# ) %>%
#   as.data.frame() %>%
#   setNames(
#     c("Intercept", "Gau prec", "Wind RW prec", "PR effect")
#   )
# write.csv(temp_summary, fname)

# temp_summary %>%
#   kable(digits = c(2, 1, 0, 2), format = "latex") %>%
#   kable_styling(
#     latex_options = "scale_down"
#   )


```
:::

::: {.column width="40%"}

\centering
\small Effects
```{r fig.height = 3}

# plot.hyper.dens(mod.temp)

# plot.effects(mod.temp,"ws.w_group")
```
\small Hyperparameters
```{r fig.height = 5}

# plot.hyper.dens(mod.temp)

# plot.effects(mod.temp,"ws.w_group")
```
:::

:::


## PR-AR1-NEN model

::: {.columns}

::: {.column width="60%"}
\centering
\small
Parameters summary
\tiny
```{r}
# path <- "~/Documents/proj2/spatial/model_objects/"
# mod.temp <- readRDS(file.path(path,"r_err.cf_f_gaussian_eta_feat_ws.w_group-ar1g-etaderiv.rds"))

# # print(mod.temp$.args$formula)
# cbind(
# mod.temp$summary.fixed[-7] %>% t(),
# mod.temp$summary.hyperpar %>% t() 
# ) %>% 
#     as.data.frame() %>% 
#     setNames(
#         c("Intercept", "Gau prec","Wind RW prec","AR prec","Rho T","Group Rho","PR effect")
#     ) %>% 
#     kable(digits = c(2,0,2,2,2,2,2), format = "latex") %>% 
#     kable_styling(
#       latex_options = "scale_down"
#     )

```
:::

::: {.column width="40%"}

\centering
\small Effects
```{r fig.height = 3}


# plot.effects(mod.temp,"ws.w_group")
```
\small Hyperparameters
```{r fig.height = 5}

# plot.hyper.dens(mod.temp)

```
:::

:::


## ST-NEN model

::: {.columns}

::: {.column width="60%"}
\centering
\small
Parameters summary
\tiny
```{r}
# path <- "~/Documents/proj2/spatial/model_objects/"
# mod.temp <- readRDS(file.path(path,"r_err.cf_f_gaussian_fd_feat_ws.w_group-matern-ar1.rds"))

# # print(mod.temp$.args$formula)
# cbind(
# mod.temp$summary.fixed[-7] %>% t(),
# mod.temp$summary.hyperpar %>% t() 
# ) %>% 
#     as.data.frame() %>% 
#     setNames(
#         c("Intercept", "Gau prec","Wind RW prec","Range","Spat sd","Rho t")
#     ) %>% 
#     kable(digits = c(2,0,0,1,2,2), format = "latex") %>% 
#     kable_styling(
#       latex_options = "scale_down"
#     )

```
:::

::: {.column width="40%"}

\centering
\small Effects
```{r fig.height = 3}
# 
# plot.effects(mod.temp,"ws.w_group")
```
\small Hyperparameters
```{r fig.height = 5}

# plot.hyper.dens(mod.temp)

```
:::

:::


# Appendix 

## Map and mesh


::: {.columns}

::: {.column width="50%"}

\footnotesize
\centering
Map of wind farm samples
\includegraphics[width=\linewidth,height=5cm,keepaspectratio]{../fig/Scottish_wfsamp_24_map.pdf}
:::

::: {.column width="50%"}
\centering
\small Mesh

\includegraphics[width=\linewidth,height=5cm,keepaspectratio]{../fig/meshhex_Scottish_wfsamp.pdf}
:::

:::


# Power Curve fitting{-}

## Classic parametric shape

::: {.columns}

::: {.column width="50%"}

\footnotesize
The five-parameter formula (Lydia et.al, 2013):

\begin{equation*}
  P(u) = D+ \frac{A-D}{(1+(u/C)^B)^G} 
\end{equation*}
where: $A$ and $D$ are the upper and lower asymptotes, $C$ controls the inflection point, $B$ is related to the slope at inflection point, and $G$ controls the asymmetry.

:::

::: {.column width="50%"}
\centering
\small 5 parameters power curve
```{r fig.width = 4.5, fig.height = 3.5}
pc5param <- function(x, A, B, C, D, G) {
  D + (A - D) / (1 + (x / C)^B)^G
}
D <- 0
A <- 1
B = -15
G = 0.4
C = 7
w <- seq(0, 25, length.out = 100)
p <- pc5param(w, A, B, C, D, G)

data.frame(
  wind = w,
  power = p
) %>%
  ggplot(aes(wind, power)) +
  geom_line(col = blues9[7])
```

:::

:::

## Parametric shape for cut-off

::: {.columns}

::: {.column width="50%"}

\footnotesize
Adding extra parameters we can model de decay after cut-off:

\begin{equation*}
  P(u) = D+ \frac{A-D}{(1+(u/C_1)^B_1)^G(1+(u/C_2)^B_2)^G} 
\end{equation*}
where: $A$ and $D$ are the upper and lower asymptotes, $C_1$ is the first inflection point, $C_2$ is related to the cut-off, $B_1$ is related to the slope at inflection point, $B_2$ to the slope during cut-off, and $G$ controls the asymmetry.

:::

::: {.column width="50%"}

\centering
\small 7 parameters power curve

```{r fig.width = 4.5, fig.height = 3.5}
pc7param_r <- function(x, A_raw, B1_raw, C1, D, G_raw, C2, B2_raw) {
  B1 <- -exp(B1_raw) # always negative
  B2 <- exp(B2_raw) # always positive
  A <- D + exp(A_raw) # ensures A > D
  G <- exp(G_raw) # ensures G > 0

  D +
    (A - D) /
      (1 + (x / C1)^B1)^G /
      (1 + (x / C2)^B2)^G
}
D <- 0
A <- 1
B1 = log(15)
B2 = log(100)
G = log(0.4)
C1 = 7
C2 = 22
w <- seq(0, 30, length.out = 100)
p <- pc7param_r(w, A, B1, C1, D, G, C2, B2)

data.frame(
  wind = w,
  power = p
) %>%
  ggplot(aes(wind, power)) +
  geom_line(col = blues9[7])
```

:::

:::


## Parametric fit for Scottish wind farms

::: {.columns}

::: {.column width="50%"}

\footnotesize

- We can fit the parametric shape using optim
- As long as there is a reasonable amount of points showing the cut-off optim can converge

\tiny
\centering
Estimates from data
```{r}
solution1 <- read.csv(file.path(pre_path,"data/pc_7pars_wfsamp_24.csv")) %>%
  rename(par = X)
solution1 %>%
  kable(digits = 2, format = "latex") %>%
  kable_styling(full_width = FALSE)
```
:::

::: {.column width="50%"}
\centering
\small Data and power curve estimate

\includegraphics[width=\linewidth,height=5cm,keepaspectratio]{../fig/scot_wfsamp_24_pc-est.png}
:::

:::
